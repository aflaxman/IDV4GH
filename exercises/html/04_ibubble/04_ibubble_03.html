
<!DOCTYPE html>
<meta charset="utf-8">

<style>
.dot {
  stroke: black;
  stroke-width: 1;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>

<body>

<p>An interactive bubble chart.</p>

<script src="../d3.v3.js"></script>
<script src="../nations.js"></script>
<script src="../keybinding.js"></script>


<script>
// javascript goes here
var margin = {top: 10, right: 10,
              bottom: 20, left: 40},
    width = 960 - margin.left
            - margin.right,
    height = 500 - margin.top
            - margin.bottom;

var svg = d3.select("body").append("svg")
    .attr("width", width
          + margin.left + margin.right)
    .attr("height", height
          + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
      "translate(" + margin.left + ","
         + margin.top + ")");

var year = 2000;

var xScale = d3.scale.log()
               .domain([300, 1e5])
               .range([0, width]),
    yScale = d3.scale.linear()
               .domain([10, 85])
               .range([height, 0]),
    radiusScale = d3.scale.sqrt()
                    .domain([1, 5e8])
                    .range([1, 40]),
    colorScale = d3.scale.category10();
    
function position(dot) {
    dot .attr("r", function(d) {
          return radiusScale(
            d.population[year]); })
        .attr("cx", function(d) {
          return xScale(
            d.income[year]); })
        .attr("cy", function(d) {
          return yScale(
            d.lifeExpectancy[year]); });
}

// The x & y axes.
var xAxis = d3.svg.axis()
              .orient("bottom").scale(xScale)
              .ticks(12, d3.format(",d")),
    yAxis = d3.svg.axis()
              .scale(yScale).orient("left");

// Add the x-axis.
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

// Add the y-axis.
svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

// Add an x-axis label.
svg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "end")
    .attr("x", width)
    .attr("y", height - 6)
    .text("income per capita, inflation-adjusted (dollars)");

// Add a y-axis label.
svg.append("text")
    .attr("class", "y label")
    .attr("text-anchor", "end")
    .attr("y", 6)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("life expectancy (years)");

// Add the year label; the value is set on transition.
var label = svg.append("text")
    .attr("class", "year label")
    .attr("text-anchor", "end")
    .attr("y", height - 24)
    .attr("x", width)
    .text(year);

d3.select('body').call(d3.keybinding()
    .on('←', changeYear(-5))
    .on('→', changeYear(5)));
    
function changeYear(delta) {
    return function(event) {        
        year = Math.max(1990, Math.min(2005, year+delta));
        dot.transition().call(position).ease("linear");
        svg.select(".x.axis").call(xAxis);
        svg.select(".y.axis").call(yAxis);
        label.text(year);
    };
}

var dot = svg.selectAll(".dot")
    .data(nations)
    .enter()
    .append("circle")
    .attr("class", "dot")
    .attr("opacity", .8)
    .style("fill", function(d) {
      return colorScale(d.region); })
    .call(position);

// Add a title.
dot .append("title")
   .text(function(d) { return d.name; });

// Add controls
controls = d3.select("body")
    .append("div")
    .attr("id", "controls")

var regions = d3.set(
    nations
        .map(function (d) {
            return d.region; }))
    .values()
    .sort();
regions = ['All'].concat(regions);
    
controls.append("select")
    .on("change", filterNations)
    .selectAll("option")
    .data(regions)
    .enter()
    .append("option")
    .attr("value", Object)
    .text(Object);
    
function filterNations() {
    //console.log(this.value);
    var showRegion = this.value;
    // sort so that shown region is on top (really part of details on demand)
    dot.sort(function (a,b) {
        if(a.region === showRegion) {
            return 1;
        } else {
            return 0;
        }});
    dot.transition()
        .attr("opacity", function (d) {
            if (showRegion === "All") {
                return .8;
            }
            if(d.region === showRegion) {
                return .8;
            } else {
                return .1;
            }
        })
}

</script>
